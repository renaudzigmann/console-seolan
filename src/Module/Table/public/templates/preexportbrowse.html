
<div class="title"><%$syslabels.Seolan_Core_General.export_text%> - <%$imod_props.modulename%></div>

<div id="preexportbrowse<%$uniqid%>">
  <form name="exportForm_<%$uniqid%>" id="exportForm_<%$uniqid%>" class="form-horizontal" action="<%$self%>" method="post" onsubmit="return runExport(this, '<%$uniqid%>',false);">
    <input type="hidden" name="fromfunction" value="<%$smarty.request.fromfunction%>" />
    <input type="hidden" name="function" value="export" />
    <input type="hidden" name="tplentry" value="br" />
    <input type="hidden" name="moid" value="<%$_moid%>" />
    <input type="hidden" name="select" value="<%$smarty.request.select%>" />
    <input type="hidden" name="template" value="Core.empty.html" />
    <input type="hidden" name="_linkedfield" value="" />
    <input type="hidden" name="_recordcount" value="<%$br_record_count|default:0%>" />
    <input type="hidden" name="_selectedok" value="ok" />
    <input type="hidden" name="statusFileId" value="" />
    <%foreach from=$br__selected item=v key=k %>
    <input type="hidden" name="_selected[<%$k%>]" value="on" />
    <%/foreach%>
    <%* champs pour la gestion des procedures stockées *%>
    <input type="hidden" name="storedprocedurename" value="" />
    <input type="hidden" name="storedprocedureid" value="" />
    <input type="hidden" name="_next" value="" />
    <div class="form-group">
      <div class="col-xs-12">
	<%include inline file='Module/Table.pre_selection_count.html'%>
        <%foreach name=i from=$br_queryfields item=field%>
        <%$field->fielddef->label%> : <%$field->getQueryText()%><br>
	<%/foreach%>
      </div>
    </div>
    <div class="row export-select">
      <div class="col-xs-12 col-sm-12 col-md-4">
        <h5><%$syslabels.Seolan_Module_Table_Table.export_allfields_text%></h5>
        <%if $br___ssmod|count %>
        <select class="form-control" name="_target" id="_target<%$uniqid%>" onchange="changeTarget();">
          <option selected value="<%$imod_props._moid%>"><%$imod_props.modulename%></option>
          <%section loop=$br___ssmod name="ssmod"%>
          <option value="<%$br___ssprops[ssmod]._moid%>"><%$br___ssprops[ssmod].modulename%></option>
          <%/section%>
        </select>
        <%else%>
        <input type="hidden" name="_target" id="_target<%$uniqid%>" value="<%$imod_props._moid%>">
        <%/if%>
        <div class="export-fields" id="export-fields<%$uniqid%>">
          <ul class="export-list">
          </ul>
        </div>
      </div>

      <div class="col-xs-12 col-sm-6 col-md-4">
        <h5><%$syslabels.Seolan_Module_Table_Table.export_actions_text%></h5>
        <div class="export-actions">
          <ul class="ul-list-inline">

            <li><button type="button" class="btn btn-default" aria-expanded="false" onclick="exportAddAllFields('<%$uniqid%>')"><span class="glyphicon csico-list-add" aria-hidden="true"></span><%$syslabels.Seolan_Module_Table_Table.export_addall_text%></button></li>

            <li><button type="button" class="btn btn-default" aria-expanded="false" onclick="exportAddFields('<%$uniqid%>')"><span class="glyphicon csico-plus" aria-hidden="true"></span><%$syslabels.Seolan_Module_Table_Table.export_add_text%></button></li>
            <li><button type="button" class="btn btn-default" aria-expanded="false" onclick="exportRemoveField('<%$uniqid%>')"><span class="glyphicon csico-minus" aria-hidden="true"></span><%$syslabels.Seolan_Module_Table_Table.export_del_text%></button></li>
            <li><button type="button" class="btn btn-default" aria-expanded="false" onclick="clearAllFields('<%$uniqid%>')"><span class="glyphicon csico-list-remove" aria-hidden="true"></span><%$syslabels.Seolan_Module_Table_Table.export_clear_text%></button></li>
          </ul>
        </div>
        <div class="export-field-options">
	  <div class="export-field-options-title">
	  <label><h5><%$syslabels.Seolan_Core_General.field_text%><%$syslabels.Seolan_Core_General.i18ncolon%>"<span class="export-selected-field"></span>"</h5></label>
	  <a class="btn btn-primary" onclick="jQuery(this).parent().parent().find('div.export-types').toggle();"><%$syslabels.Seolan_Core_General.personnalize_text%><%$syslabels.Seolan_Core_General.edit%></a>
	  </div>
          <div class="export-types" style="display:none">
            <div class="form-group">
              <label class="col-xs-12"><%$syslabels.Seolan_Module_Table_Table.export_files_names_format_text%></label>
              <div class="col-xs-12"><input type="text" class="naming_convention"></div>
            </div>
            <div class="form-group">
              <div class="col-xs-12">
                <div class="checkbox">
                  <label>
                    <input class="exportfileurl checkbox" name="exportfileurl" value="1" type="checkbox">
                    <%$syslabels.Seolan_Module_Table_Table.exporturlfiles_text%>
                  </label>
                </div>
              </div>
            </div>
            <div class="export-image-field">
	      <div class="form-group notAnImageMess"><label class="col-xs-12"><small><%$syslabels.Seolan_Module_Table_Table.export_file_options_mess%></small></label></div>
              <div class="form-group">
                <label class="col-xs-12"><%$syslabels.Seolan_Module_Table_Table.export_format_text%></label>
                <div class="col-xs-12">
                  <label class="radio-inline"><input type="radio" name="inlineRadioOptions" class="format" value="origin" checked><%$syslabels.Seolan_Module_Table_Table.export_origin_text%></label>
                  <label class="radio-inline"><input type="radio" name="inlineRadioOptions" class="format" value="png"><%$syslabels.Seolan_Module_Table_Table.export_png_text%></label>
                  <label class="radio-inline"><input type="radio" name="inlineRadioOptions" class="format" value="jpeg"><%$syslabels.Seolan_Module_Table_Table.export_jpeg_text%></label>
                </div>
              </div>
              <div class="form-group">
                <label class="col-xs-12"><%$syslabels.Seolan_Core_General.size_text%></label>
                <div class="col-xs-12">
                  <label class="radio-inline"><input type="radio" name="inlineRadioOptions1" class="pictureSizeOption" value="origin" checked><%$syslabels.Seolan_Module_Table_Table.export_origin_text%></label>
                  <label class="radio-inline"><input type="radio" name="inlineRadioOptions1" class="pictureSizeOption" value="custom"><%$syslabels.Seolan_Module_Table_Table.export_custom_text%></label>
                  <div class="img-value">
		    <div class="form-group">
		    <label class="col-md-3"><%$syslabels.Seolan_Module_Table_Table.export_width_text%><%$syslabels.Seolan_Core_i18ncolon%></label>
		    <div class="col-md-9"><input type="number" step="1" min="0" class="width filecomplement"></div>
		    </div>
		    <div class="form-group">
                    <label  class="col-md-3"><%$syslabels.Seolan_Module_Table_Table.export_height_text%><%$syslabels.Seolan_Core_i18ncolon%></label>
		    <div class="col-md-9"><input type="number" step="1" min="0" class="height filecomplement"></div>
		    </div>
                    <label><input type="checkbox" class="crop filecomplement" value="crop"><%$syslabels.Seolan_Module_Table_Table.export_crop_larger%></label>
                    <label><input type="checkbox" class="extent filecomplement" value="extent"><%$syslabels.Seolan_Module_Table_Table.export_extent_smaller%></label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <%if $lang_code|@count>1%>
          <h5><%$syslabels.Seolan_Module_Table_Table.export_langs_text%></h5>
          <div class="export-langs">
            <select class="form-control" name="langs[]" multiple>
              <%section name=lang loop=$lang_code%>
                <option value="<%$lang_code[lang]%>"<%if $lang_data==$lang_code[lang]%> selected<%/if%>><%$lang_text[lang]%></option>
              <%/section%>
            </select>
          </div>
        <%/if%>
      </div>
      <div class="col-xs-12 col-sm-6 col-md-4">
        <h5><%$syslabels.Seolan_Module_Table_Table.export_selectedfields_text%></h5>
        <div class="export-fields-selected" id="export-fields-selected<%$uniqid%>"></div>
	<h5><%$syslabels.Seolan_Core_General.order%></h5>
	<select class="form-control" name="order[]" size="4" multiple></select>
      </div>
    </div>
    <div class="row export-options">
      <div class="col-xs-12"><h5><%$syslabels.Seolan_Module_Table_Table.options_text%></h5></div>
      <div class="col-xs-12 col-sm-6">
        <div class="form-group">
          <label class="col-xs-12 col-md-3"><%$syslabels.Seolan_Module_Table_Table.export_format_text%></label>
          <div class="col-xs-12 col-md-9">
            <%if $br_record_count <= $smarty.const.TZR_MAX_EXPORT_XLS%>
		 <select name="fmt" onchange="changeFmt();">
                   <option value="xl07">Excel 2007</option>
                   <option value="csv">CSV</option>
		 </select>
		 <%else%>
		 <%$syslabels.Seolan_Module_Table_Table.export_csvonly_text%><%$br_record_count%> <%$syslabels.Seolan_Module_Table_Table.exportrecord%> <%$syslabels.Seolan_Core_Field_Field.too_many_results%>
		 <input type="hidden" name="fmt" value="csv">
		 <%/if%>
          </div>
	 </div>
	</div>
	<div class="col-xs-12 col-sm-6" id="includeimages">
	 <div class="form-group">
	  <label class="col-xs-12 col-md-3"><%$syslabels.Seolan_Module_Table_Table.includeimages%></label>
	  <div class="col-xs-12 col-md-9">
	   <div class="checkbox">
	    <label><input class="checkbox" type="checkbox" name="includeimages" value="1" onchange="jQuery('#includeimagesheight').toggle(jQuery(this).prop('checked'))">
	     <%$syslabels.Seolan_Module_Table_Table.includeimagesexpli%></label>
	    </div>
	   </div>
	  </div>
	  <div class="form-group" id="includeimagesheight" style="display:none">
	   <label class="col-xs-12 col-md-3"><%$syslabels.Seolan_Module_Table_Table.imageheight%></label>
	   <div class="col-xs-12 col-md-9">
	    <input type="number" name="imagesheight" value="100" style="width:5em">&nbsp;px
	   </div>
	  </div>
	 </div>
      <div class="col-xs-12 col-sm-6">
        <div class="form-group">
          <label class="col-xs-12 col-md-3"><%$syslabels.Seolan_Module_Table_Table.exportfiles%></label>
          <div class="col-xs-12 col-md-9">
            <div class="checkbox">
              <label>
                <input class="checkbox" name="exportfiles" value="1" type="checkbox">
                <%$syslabels.Seolan_Module_Table_Table.exportfilesexpli%>
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xs-12 col-sm-6">
        <div class="form-group">
          <label class="col-xs-12 col-md-3"><%$syslabels.Seolan_Module_Table_Table.exportftp%></label>
          <div class="col-xs-12 col-md-9">
            <div class="checkbox">
              <label>
                <input class="checkbox" name="exportftp" id="exportftp" value="1" onchange="changeExportFtp(this);" type="checkbox">
                <%$syslabels.Seolan_Module_Table_Table.exportftpexpli%>
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xs-12 col-sm-6">
        <div class="form-group">
          <label class="col-xs-12 col-md-3"><%$syslabels.Seolan_Module_Table_Table.identifiersvisible%></label>
          <div class="col-xs-12 col-md-9">
            <div class="checkbox">
              <label>
                <input class="checkbox" name="oidisvisible" type="checkbox">
                <%$syslabels.Seolan_Module_Table_Table.identifiersvisibleexpli%>
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xs-12 col-sm-6">
        <div class="form-group">
          <label class="col-xs-12 col-md-3"><%$syslabels.Seolan_Module_Table_Table.filename%></label>
          <div class="col-xs-12 col-md-9">
            <input class="form-control" value="<%$br_proposedfilename|rewriteToFilename|escape:'html'%>" name="fname" size="50" type="text">
          </div>
        </div>
      </div>
    </div>
    <div id="fieldsetcsv" style="display:none;">
      <div class="row export-options">
        <div class="col-xs-12"><h5><%$syslabels.Seolan_Core_General.options_text%> CSV</h5></div>
        <div class="col-xs-12 col-sm-4">
          <div class="form-group">
            <label class="col-xs-12 col-md-5"><%$syslabels.Seolan_Module_Table_Table.exportcsvfsep%></label>
            <div class="col-xs-12 col-md-7">
              <input name="csvfsep" value=";" maxlength="1" size="1" type="text">
            </div>
          </div>
        </div>
	
        <div class="col-xs-12 col-sm-4">
          <div class="form-group">
            <label class="col-xs-12 col-md-5"><%$syslabels.Seolan_Module_Table_Table.exportcsvtextsep%></label>
            <div class="col-xs-12 col-md-7">
              <input name="csvtextsep" value="&quot;" maxlength="1" size="1" type="text">
            </div>
          </div>
        </div>
	
        <div class="col-xs-12 col-sm-4">
          <div class="form-group">
            <label class="col-xs-12 col-md-5"><%$syslabels.Seolan_Module_Table_Table.exportcharset%></label>
            <div class="col-xs-12 col-md-7">
              <select name="csvcharset">
                <option value="UTF-8" selected="">UTF-8</option>
                <option value="<%$locale.charset%>"><%$locale.charset%></option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="fieldsetftp" style="display:none;">
      <div class="row export-options">
        <div class="col-xs-12"><h5><%$syslabels.Seolan_Module_Table_Table.export_ftp_options_text%></h5></div>
        <div class="col-xs-12 col-sm-4">
          <div class="form-group">
            <label class="col-xs-12 col-md-5"><%$syslabels.Seolan_Module_Table_Table.export_ftp_server_text%></label>
            <div class="col-xs-12 col-md-7">
              <input name="ftpserver" type="text">
            </div>
          </div>
        </div>

        <div class="col-xs-12 col-sm-4">
          <div class="form-group">
            <label class="col-xs-12 col-md-5"><%$syslabels.Seolan_Module_Table_Table.export_ftp_login_text%></label>
            <div class="col-xs-12 col-md-7">
              <input name="ftplogin" type="text">
            </div>
          </div>
        </div>

        <div class="col-xs-12 col-sm-4">
          <div class="form-group">
            <label class="col-xs-12 col-md-5"><%$syslabels.Seolan_Module_Table_Table.export_ftp_password_text%></label>
            <div class="col-xs-12 col-md-7">
              <input name="ftppassword" type="text">
            </div>
          </div>
        </div>
	<%* to do
        <div class="col-xs-12 col-sm-4">
          <div class="form-group">
            <div class="col-xs-12 col-md-7 col-md-offset-5">
              <button type="button" class="btn btn-primary" aria-expanded="false" onclick="saveFTPAccount()"><span class="glyphicon csico-save" aria-hidden="true"></span><%$syslabels.Seolan_Module_Table_Table.export_ftp_save_connexion_text%></button>
            </div>
          </div>
        </div>
	*%>
      </div><!-- /export-options -->
    </div>

  </form>

</div>

    <div id="tzr-action<%$uniqid%>" class="tzr-action col-lg-12">
      <ul>
	<li><label><%$syslabels.Seolan_Module_Table_Table.stored_export%><label><%$syslabels.Seolan_Core_General.i18ncolon%></li>
	  <li>
	    <input type="text" list="storedprocedureslist" value="" class="ui-autocomplete-input" placeholder="<%$syslabels.Seolan_Core_General.name%>" name="storedprocedurename" id="storedprocedurename" >
	  <input type="hidden" value="" name="storedprocedureid">
	  <datalist id="storedprocedureslist">
            <%section name=le loop=$br__procedures.lines_oid%>
              <%if !$br__procedures.lines_otitle[le]->html|@strstr:'REP_'%>
                <option data-oid="<%$br__procedures.lines_oid[le]%>"><%$br__procedures.lines_otitle[le]->html%></option>
              <%/if%>
            <%/section%>
	  </datalist>
	  </li>
	  <li>
	    <button type="button" class="btn btn-primary" aria-expanded="false" onclick="exportProcedure('load');"><%$syslabels.Seolan_Module_Table_Table.load_text%></button>
      <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="glyphicon csico-ellipsis-h" aria-hidden="true" style="margin-right:0"></span></button>
      <ul class="dropdown-menu" style="padding: 5px;">
        <li><button type="button" class="btn btn-primary" aria-expanded="false" onclick="exportProcedure('save');"><%$syslabels.Seolan_Core_General.save_text%></button></li>
        <li><button type="button" class="btn btn-primary" aria-expanded="false" onclick="exportProcedure('savedefault');"><%$syslabels.Seolan_Core_General.savedefault_text%></button></li>
        <%if $root%>
          <li><button type="button" class="btn btn-primary" aria-expanded="false" onclick="exportProcedure('savedefaulteverybody');"><%$syslabels.Seolan_Core_General.savedefaulteverybody_text%></button></li>
        <%/if%>
        <li><button type="button" class="btn btn-default" aria-expanded="false" onclick="exportProcedure('delete');"><%$syslabels.Seolan_Core_General.del_text%></button></li>
      </ul>
	  </li>
      </ul>
      
      <ul>
        <li><button class="btn btn-primary" type="button" onclick="return runExport(document.forms['exportForm_<%$uniqid%>'], '<%$uniqid%>', true);" _no_edge_form="exportForm_<%$uniqid%>"><span class="glyphicon csico-download" aria-hidden="true"></span><%$syslabels.Seolan_Core_General.export_text%></button></li>
        <li><button class="btn btn-default" type="button" data-dismiss="modal"><%$syslabels.Seolan_Core_General.close_text%></button></li>
      </ul>

    </div>

    <div id="exportoverlay<%$uniqid%>" style="display:none">
      <h4><%$syslabels.Seolan_Core_General.downloading%></h4>
      <label><strong><%$syslabels.Seolan_Module_Table_Table.export%><span class="recordcount">0</strong> /  <span class="totalrecord"><%$br_record_count%></span></span> <%$syslabels.Seolan_Module_Table_Table.records%></label>
      <div class="progress">
	<div class="progress-bar progress-bar-success progress-bar-striped" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
    </div>


<script type="text/javascript">
 function ssmods_compOrders(a, b){
   if (a.order < b.order)
     return -1;
   else if(a.order > b.order)
     return 1;
   else
     return 0;
 }
 <%assign var=defaultgroup value=$syslabels.Seolan_Core_General.general_text%>
 <%if $smarty.request._dialogid%><%assign var='downloaderid' value=$smarty.request._dialogid%><%else%><%assign var='downloaderid' value=$uniqid%><%/if%>
 var act = false;
 var ssmodfields = []
 var ssmodbfields = [];
 var ssmodlf = [];
var ssmodgroups = [];
 ssmodlf[<%$imod_props._moid%>] = ""; // linkfield 
 ssmodfields[<%$imod_props._moid%>] = []; // fields
 <%* les champs du module *%>
 <%section name="f" loop=$br_header_fields%>
 ssmodfields[<%$imod_props._moid%>].push(
   {group:"<%$br_header_fields[f]->fgroup|default:$defaultgroup|escape:'javascript'%>",
    label:"<%$br_header_fields[f]->label|escape:'javascript'%>",
    order:"<%$br_header_fields[f]->fgroup|escape:'javascript'%><%"%06d"|sprintf:$br_header_fields[f]->forder|default:0%>",
    field:"<%$br_header_fields[f]->field%>",
    target:"<%$br_header_fields[f]->target%>",
    targetfields : [],
    type:"<%"\\"|explode:$br_header_fields[f]->ftype|array_pop%>",
    tofollow:<%if $br_header_fields[f]->targetfields%>true<%else%>false<%/if%>,
    isAnImage:<%if $br_header_fields[f]|is_a:'\Seolan\Field\Image\Image'%>true<%else%>false<%/if%>,
    isAFile:<%if $br_header_fields[f]|is_a:'\Seolan\Field\File\File'%>true<%else%>false<%/if%>,
    browsable:<%if $br_header_fields[f]->browsable%>true<%else%>false<%/if%>
   });
 <%* les targetfields possible des liens *%>
 <%if $br_header_fields[f]->targetfields%>
 <%foreach from=$br_header_fields[f]->targetfields item="fielddef"%>
 ssmodfields[<%$imod_props._moid%>][<%$smarty.section.f.index%>]['targetfields'].push({
   group:"<%$fielddef->fgroup|default:$defaultgroup|escape:'javascript'%>",
   label:"<%$fielddef->label|escape:'javascript'%>",
   order:"<%$fielddef->fgroup|escape:'javascript'%><%"%06d"|sprintf:$fielddef->forder%>",
   field:"<%$fielddef->field%>",
   type:"<%"\\"|explode:$fielddef->ftype|array_pop%>",
   isAnImage:<%if $fielddef|is_a:'\Seolan\Field\Image\Image'%>true<%else%>false<%/if%>,
   isAFile:<%if $fielddef|is_a:'\Seolan\Field\File\File'%>true<%else%>false<%/if%>,
 });
 <%/foreach%>
 ssmodfields[<%$imod_props._moid%>][<%$smarty.section.f.index%>]['targetfields'].sort(ssmods_compOrders);
 <%/if%>
 <%/section%>
 ssmodfields[<%$imod_props._moid%>].sort(ssmods_compOrders);
 <%* les champs des sous modules *%>
 <%section loop=$br___ssmod name="ssmod"%>
 ssmodlf[<%$br___ssprops[ssmod]._moid%>] = "<%$br___ssprops[ssmod].linkedfield%>";
 ssmodfields[<%$br___ssprops[ssmod]._moid%>] = [];
 <%section name="f" loop=$br___ssmod[ssmod].header_fields%>
 ssmodfields[<%$br___ssprops[ssmod]._moid%>].push(
   {group:"<%$br___ssmod[ssmod].header_fields[f]->fgroup|default:$defaultgroup|escape:'javascript'%>",
    label:"<%$br___ssmod[ssmod].header_fields[f]->label|escape:"javascript"%>",
    order:"<%$br___ssmod[ssmod].header_fields[f]->fgroup|escape:'javascript'%><%"%06d"|sprintf:$br___ssmod[ssmod].header_fields[f]->forder%>",
    field:"<%$br___ssmod[ssmod].header_fields[f]->field%>",
    target:"<%$br___ssmod[ssmod].header_fields[f]->target%>",
    targetfields : [],
    type:"<%"\\"|explode:$br___ssmod[ssmod].header_fields[f]->ftype|array_pop%>",
    tofollow:<%if $br___ssmod[ssmod].header_fields[f]->targetfields%>true<%else%>false<%/if%>,
    isAnImage:<%if $br___ssmod[ssmod].header_fields[f]|is_a:'\Seolan\Field\Image\Image'%>true<%else%>false<%/if%>,
    isAFile:<%if $br___ssmod[ssmod].header_fields[f]|is_a:'\Seolan\Field\File\File'%>true<%else%>false<%/if%>,
    browsable:<%if $br___ssmod[ssmod].header_fields[f]->browsable%>true<%else%>false<%/if%>});
 <%* les targets fields possibles des champs liens *%>
 <%if $br___ssmod[ssmod].header_fields[f]->targetfields%>
 <%foreach from=$br___ssmod[ssmod].header_fields[f]->targetfields item="fielddef"%>
 ssmodfields[<%$br___ssprops[ssmod]._moid%>][<%$smarty.section.f.index%>]['targetfields'].push({
   group:"<%$fielddef->fgroup|default:$syslabels.Seolan_Core_General.general_text|escape:'javascript'%>",
   label:"<%$fielddef->label|escape:'javascript'%>",
   order:"<%$fielddef->fgroup|escape:'javascript'%><%"%06d"|sprintf:$fielddef->forder%>",
   field:"<%$fielddef->field%>",
   type:"<%"\\"|explode:$fielddef->ftype|array_pop%>",
   isAnImage:<%if $fielddef|is_a:'\Seolan\Field\Image\Image'%>true<%else%>false<%/if%>,
   isAFile:<%if $fielddef|is_a:'\Seolan\Field\File\File'%>true<%else%>false<%/if%>,
 });
 <%/foreach%>
 ssmodfields[<%$br___ssprops[ssmod]._moid%>][<%$smarty.section.f.index%>]['targetfields'].sort(ssmods_compOrders);
 <%/if%>
 <%/section%>
 ssmodfields[<%$br___ssprops[ssmod]._moid%>].sort(ssmods_compOrders);
 <%/section%>
 var act = false;
 function changeFmt() {
   if (act) {
     document.getElementById(act).style.display = "none";
   }
   var v = document.forms['exportForm_<%$uniqid%>'].fmt.value;
   var t = document.forms['exportForm_<%$uniqid%>']._target.value;
   var id = "";
   if (v == 'xl07')
     v = 'xl';
   if (t != "<%$imod_props._moid%>" && document.getElementById('ssmodfieldset' + v)) {
     id = 'ssmodfieldset' + v;
   } else if (document.getElementById('fieldset' + v)) {
     id = 'fieldset' + v;
   }
   if (id != "") {
     document.getElementById(id).style.display = "block";
     act = id;
   } else {
     act = false;
   }
   if (v !== 'xl') {
     jQuery('#includeimages').hide();
     jQuery('input[name=includeimages]').prop('checked', false).change();
   } else {
     jQuery('#includeimages').show();
   }
 }
 function getTargetFieldGroup(moid, fn, tf){
   var groups = getGroups(moid,fn);
   if (groups.length <= 1)
     return '';
   return ssmodfields[moid][fn].targetfields[tf].group;
 }
 function getFieldGroup(moid,fn){
   var groups = getGroups(moid);
   if (groups.length <= 1)
     return '';
   return ssmodfields[moid][fn].group;
 }
 function getGroups(moid,lfn){
   if (lfn){
     var k = moid+'-'+lfn;
     var fields = ssmodfields[moid][lfn].targetfields;
   } else {
     var k = moid;
     var fields = ssmodfields[moid];
   }
   if (typeof(ssmodgroups[k]) != "undefined"){
     return ssmodgroups[k];
   }
   ssmodgroups[k] = [];
   
   for(o in fields){
     if (fields[o].group != '' 
       && ssmodgroups[k].indexOf(fields[o].group) == -1){
       ssmodgroups[k].push(fields[o].group);
     }
   }
   return ssmodgroups[k];
 }
 // affichage de la liste des champs du module (sous module) selectionné
 function changeTarget() {
   
   hideFieldsOptions("<%$uniqid%>");

   var form = document.forms['exportForm_<%$uniqid%>'];
   var v = form.elements['_target'].value;
   if (typeof form.elements['_target'].selectedIndex != "undefined"){
     var l = form.elements['_target'].options[form.elements['_target'].selectedIndex].label;
     TZR.Dialog.changeTitle('Export - '+l);
   } 

   var allFields = jQuery('div#export-fields<%$uniqid%> .export-list');
   allFields.html('');

   var selectedFields = jQuery('div#export-fields-selected<%$uniqid%>');
   selectedFields.html('');

   var sor = form.elements["order[]"];
   sor.innerHTML = '';

   form.elements["_linkedfield"].value = ssmodlf[v];
   var group = '';
   var allFieldsHtml = '';
   var allToClose = [];
   var selectedFieldsHtml = '';
   for (var c in ssmodfields[v]) {
     var fn = ssmodfields[v][c].field;
     var target = ssmodfields[v][c].target;
     var fgroup = getFieldGroup(v,c);
     if (group != fgroup){
       group = fgroup;
       if (allFieldsHtml != '') {
         allFieldsHtml += allToClose.pop();
       }
       allFieldsHtml += '<li><label class="tree-toggle fieldgroup" data-groupname="'+group+'"><span class="glyphicon csico-triangle-right" aria-hidden="true"></span>';
       allFieldsHtml += '<span class="glyphicon csico-triangle-bottom" aria-hidden="true"></span><strong>'+group+'</strong></label><ul class="tree">';
       allToClose.push('</ul></li>');

       var newgroup = document.createElement('OPTGROUP');
       newgroup.label = group;
       sor.appendChild(newgroup);

     }

     var objectFieldsHtml = '';
     var objectToClose = [];
     var ftypes = JSON.stringify({isAnImage:ssmodfields[v][c].isAnImage,isAFile:ssmodfields[v][c].isAFile});

     if  (ssmodfields[v][c].tofollow){
       var tgroup = '';
       for(var tf in ssmodfields[v][c].targetfields) {
         var tfn = ssmodfields[v][c].targetfields[tf].field;
	 var fttypes = JSON.stringify({isAnImage:ssmodfields[v][c].targetfields[tf].isAnImage,isAFile:ssmodfields[v][c].targetfields[tf].isAFile});
	 var tfgroup = getTargetFieldGroup(v,c,tf);
	 if (tgroup != tfgroup){
           tgroup = tfgroup;
           if (objectFieldsHtml.length > 0) {
             objectFieldsHtml += objectToClose.pop();
           }
	   objectToClose.push('</ul></li>');

           objectFieldsHtml += '<li><label class="tree-toggle fieldgroup" data-groupname="'+tgroup+'"><span class="glyphicon csico-triangle-right" aria-hidden="true"></span>';
           objectFieldsHtml += '<span class="glyphicon csico-triangle-bottom" aria-hidden="true"></span>'+tgroup+'</label><ul class="tree">';
         }
         objectFieldsHtml += '<li class="field" data-fieldname="'+tfn+'" data-type=\''+fttypes+'\' data-parentfield="'+fn+'" data-parentlabel="'+ssmodfields[v][c].label+'">'+ssmodfields[v][c].targetfields[tf].label+'</li>';
       }
       if (objectToClose.length >0){
	 objectFieldsHtml += objectToClose.join('');
	 objectToClose = [];
       }
       // ajout d'un pseudo champ id
       objectFieldsHtml = '<li class="field" data-fieldname=".raw" data-type=\''+fttypes+'\' data-parentfield="'+fn+'" data-parentlabel="'+ssmodfields[v][c].label+'"><%$syslabels.Seolan_Core_DataSource_DataSource.oid%></li>' + objectFieldsHtml;
       objectFieldsHtml = '<li><label class="tree-toggle field" data-fieldname="'+fn+'" data-type=\''+ftypes+'\' ><span class="glyphicon csico-triangle-right" aria-hidden="true"></span><span class="glyphicon csico-triangle-bottom" aria-hidden="true"></span>'+ssmodfields[v][c].label+'</label><ul class="tree">'+objectFieldsHtml+'</ul></li>';
       allFieldsHtml += objectFieldsHtml;
     } else {
       allFieldsHtml += '<li class="field" data-fieldname="'+fn+'" data-type=\''+ftypes+'\' data-target="'+target+'">'+ssmodfields[v][c].label+'</li>';
     }

     sor.options[sor.options.length] = new Option(ssmodfields[v][c].label, fn)

     if (ssmodfields[v][c].browsable) {
       selectedFieldsHtml += '<div class="selected-field"><span class="glyphicon csico-move" aria-hidden="true"></span>';
       selectedFieldsHtml += '<span class="field" title="%_'+fn+'" data-fieldname="'+fn+'" data-type=\''+ftypes+'\' data-target="'+target+'">'+ssmodfields[v][c].label+'</span>';
       selectedFieldsHtml += '<input type="hidden" name="selectedfields[]" value="'+fn+'">';

       if (ssmodfields[v][c].isAFile){
         selectedFieldsHtml += '<input type="hidden" name="optionsfields['+fn+'][format]" value="origin">';
         selectedFieldsHtml += '<input type="hidden" name="optionsfields['+fn+'][size]" value="origin">';
         selectedFieldsHtml += '<input type="hidden" name="optionsfields['+fn+'][crop]" value="">';
         selectedFieldsHtml += '<input type="hidden" name="optionsfields['+fn+'][extent]" value="">';
         selectedFieldsHtml += '<input type="hidden" name="optionsfields['+fn+'][naming_convention]" value="">';
         selectedFieldsHtml += '<input type="hidden" name="optionsfields['+fn+'][exportfileurl]" value="">';
       }

       selectedFieldsHtml += '</div>';
     }
   }
   if (allToClose.length >0){
     allFieldsHtml+=allToClose.join('');
     allToClose = [];
   }

   allFields.html(allFieldsHtml);
   selectedFields.html(selectedFieldsHtml);
 }
 function changeExportFtp() {
   var c = document.forms['exportForm_<%$uniqid%>'].exportftp;
   if (c.checked)
     document.getElementById("fieldsetftp").style.display = "block";
   else
     document.getElementById("fieldsetftp").style.display = "none";
 }
 function checkParams() {
   if (document.forms['exportForm_<%$uniqid%>'].exportftp.checked) {
     if (document.forms['exportForm_<%$uniqid%>'].ftpserver.value == "" || document.forms['exportForm_<%$uniqid%>'].ftplogin == "" || document.forms['exportForm_<%$uniqid%>'].ftppassword == "") {
       alert('<%$syslabels.Seolan_Module_Table_Table.exportftpcheck%>');
       return false;
     }
   }
   return true;
 }

 function exportProcedure(action) {
   if (!action)
     return;
   var proc = getExport();
   // à virer "<%$syslabels.Seolan_Module_Table_Table.export_format_name_text%>"));

   if (proc.name == ''){
     proc.jinput.focus();
     return;
   }
   if (action == 'delete'){
     if (proc.oid == null){
       proc.jinput.focus();
       return;
     }
     if (confirm("<%$syslabels.Seolan_Module_Table_Table.export_format_confirm_del_text|escape:'javascript'%>")) {
       subProcAction(proc, "delExportProcedure", delProcFromList);
     } else {
       jQuery("#storedprocedurename").val("");
     }
   } else if(action == 'save'){
     if (proc.oid !== null){
       if (confirm("<%$syslabels.Seolan_Module_Table_Table.export_format_confirm_replace_text|escape:'javascript'%>")) {
	 subProcAction(proc, "procSaveExportProcedure", addProcToList);
       } else {
	 jQuery("#storedprocedurename").val("");	 
       }
     } else {
       subProcAction(proc, "procSaveExportProcedure", addProcToList);
     }
   } else if(action == 'savedefault'){
     subProcAction(proc, "procSaveDefaultExportProcedure", addProcToList);
   } else if(action == 'savedefaulteverybody'){
     subProcAction(proc, "procSaveDefaultExportProcedureForEverybody", addProcToList);
   } else if(action == 'load'){
     if (proc.oid == null){
       proc.jinput.focus();
       return;
     }
     TZR.Table.exportselected(TZR.Dialog.currentId(), {storedprocedureid:proc.oid});
   }
 }
 // soumission d'un trt sur une procedure (del, add/update)
 function subProcAction(proc, method, actionCb){
   var form = document.forms['exportForm_<%$uniqid%>'];
   var oldfunc = form.elements['function'].value;
   form.elements['function'].value=method;
   form.elements['storedprocedurename'].value = proc.name;
   form.elements['storedprocedureid'].value = proc.oid;
   var obj = {
     url:"<%$self%>"+jQuery(form).serialize(),
     mode:"post",
     nocache:true,
     dataType:'json',
     overlay:"preexportbrowse<%$uniqid%>",
     cb:function(){
       form.elements['function'].value = oldfunc;
       try{
	 var res = JSON.parse(arguments[0]); // response text
       }catch(e){
	 res = {ok:false};
       }
       if (typeof(res.ok) != "undefined" && res.ok
	   && typeof(res.oid) != "undefined"){
	 actionCb(proc,res);
       }
     }
   };
   // todo deconnexion depuis une dialog ... à vérifier ?
   TZR.jQueryAjax(obj);
 }
 function delProcFromList(proc, res){
   jQuery('#storedprocedureslist>option[data-oid="'+proc.oid+'"]').remove();
   jQuery("#storedprocedurename").val("");
 }
 function addProcToList(proc, res){
   var list = jQuery('#storedprocedureslist');
   if (res.oid && proc.oid == null){
     var joption = jQuery("<option/>");
     joption.attr('data-oid', res.oid);
     joption.html(proc.name);
     
     var done = false;
     var name = proc.name.toUpperCase();
     var last = '';
     jQuery('option', list).each(function(i){
       var jo = jQuery(this);
       var current = jo.html().toUpperCase();
       if (name > last && name <= jo.html().toUpperCase()){
	 joption.insertBefore(jo);
	 done = true;
	 return false;
       }
       last = jo.html().toUpperCase();
     });
     if (!done){
       list.append(joption);
     }
   } else {
     // deja en place
   }
   proc.jinput.val("");
 }
 function getExport(){
   var proc = {name:null,oid:null,jinput:null};
   proc.jinput = jQuery("#storedprocedurename");
   proc.name = jQuery.trim(proc.jinput.val());
   // recherche oid 
   var list = jQuery('#storedprocedureslist>option');
   list.each(function(i){
     var jo = jQuery(this);
     if (jo.html().toUpperCase() == proc.name.toUpperCase()){
       proc.oid = jo.attr('data-oid');
       return false;
     }
   });
   return proc;
 }

 var saveFTPAccount = function() {
   var selectedFormat = jQuery('#format_export<%$uniqid%>').val();
   if (selectedFormat === ''){
     alert("<%$syslabels.Seolan_Module_Table_Table.export_saveftpaccountalert%>");
     return false;
   } else {
     var serverIP = jQuery.trim(jQuery('#exportForm_<%$uniqid%> input[name=ftpserver]').val());
     var login = jQuery.trim(jQuery('#exportForm_<%$uniqid%> input[name=ftplogin]').val());
     var password = jQuery.trim(jQuery('#exportForm_<%$uniqid%> input[name=ftppassword]').val());

     if (serverIP == '' || login == '' || password == '') {
       alert("<%$syslabels.Seolan_Module_Table_Table.export_saveftpaccountalert2%>");
       return false;
     } else {
       //TODO : save compte externe FTP associé au format d'export
       return true;
     }
   }
 };

 // ajax Post + overlay
 function runExport(dform, uniqid,subform) {
   if (dform.elements['function'].value == 'saveExportProcedure'){
     return true;
   }
   if (!checkParams()) {
     return false;
   }

   dform.elements['statusFileId'].value = new Date().getTime();

   downloader<%$downloaderid%>.currentStatusUrl = downloader<%$downloaderid%>.statusBaseUrl + jQuery('#_target'+uniqid).val() + "_" + dform.elements['statusFileId'].value;

   dform = jQuery(dform);

   if (jQuery("#exportftp", dform).is(':checked')) {   
     TZR.Dialog.hideActions();
     TZR.ajaxSubmitForm(document.forms["exportForm_<%$uniqid%>"], "#preexportbrowse<%$uniqid%>", true, null, null);
     return false;
   }

   downloader<%$downloaderid%>.exportStart(dform);

   return false;
 };
 // selection de tous les champs (sans "sous champs");
 function exportAddAllFields(uniqid){
   jQuery('#export-fields'+uniqid+' .field:not([data-parentfield])').addClass('selected');
   exportAddFields(uniqid);
   jQuery('#export-fields'+uniqid+' .selected').removeClass('selected');
 };
 function exportAddFields(uniqid){
   jQuery('#export-fields'+uniqid+' .field.selected').each(function(index, item){
     var fn = jQuery(item).data('fieldname');
     var target = jQuery(item).data('target');
     var parentfn = jQuery(item).data('parentfield');
     var ftypes = jQuery(this).data('type');  
     var ttypes = JSON.stringify(ftypes)
     var exists = false;
     jQuery('#export-fields-selected'+uniqid+' .field').each(function(index, item2) {
       if ((parentfn && jQuery(item2).data('fieldname') === parentfn+'#'+fn) || (!parentfn && jQuery(item2).data('fieldname') === fn)) {
         exists = true;
         return false;
       }
     });
     
     if (exists) {
       return;
     }
     
     var html = '<div class="selected-field"><span class="glyphicon csico-move" aria-hidden="true"></span>';
     var fieldlabel = jQuery(item).text();
     if (parentfn) {
       html += '<span title="%_'+parentfn+'.'+fn+'" class="field" data-fieldname="'+parentfn+'#'+fn+'" data-type=\''+ttypes+'\'>';
       html += jQuery(item).data('parentlabel')+' > '+fieldlabel+'</span>';
       html += '<input type="hidden" name="selectedfields[]" value="'+parentfn+'#'+fn+'">';
       
       if (ftypes.isAFile){
         html += '<input type="hidden" name="optionsfields['+parentfn+'#'+fn+'][format]" value="origin">';
         html += '<input type="hidden" name="optionsfields['+parentfn+'#'+fn+'][size]" value="origin">';
         html += '<input type="hidden" name="optionsfields['+parentfn+'#'+fn+'][crop]" value="">';
         html += '<input type="hidden" name="optionsfields['+parentfn+'#'+fn+'][extent]" value="">';
	 html += '<input type="hidden" name="optionsfields['+parentfn+'#'+fn+'][naming_convention]" value="">';
	       html += '<input type="hidden" name="optionsfields['+parentfn+'#'+fn+'][exportfileurl]" value="">';
       }
     } else {
       html += '<span title="%_'+fn+'" class="field" data-fieldname="'+fn+'" data-type=\''+ttypes+'\' data-target="'+target+'">';
       html += fieldlabel+'</span>';
       html += '<input type="hidden" name="selectedfields[]" value="'+jQuery(item).data('fieldname')+'">';
       if (ftypes.isAFile){
         html += '<input type="hidden" name="optionsfields['+fn+'][format]" value="origin">';
         html += '<input type="hidden" name="optionsfields['+fn+'][size]" value="origin">';
         html += '<input type="hidden" name="optionsfields['+fn+'][crop]" value="">';
         html += '<input type="hidden" name="optionsfields['+fn+'][extent]" value="">';
         html += '<input type="hidden" name="optionsfields['+fn+'][naming_convention]" value="">';
         html += '<input type="hidden" name="optionsfields['+fn+'][exportfileurl]" value="">';
       }
     }

     html += '</div>';
     
     jQuery('#export-fields-selected'+uniqid).append(html);
     jQuery(item).removeClass('active');
   });
 };

 function exportRemoveField(uniqid){
   hideFieldsOptions(uniqid);
 }

 function hideFieldsOptions(uniqid){
   jQuery('#export-fields-selected'+uniqid+' .selected-field.active').remove();
   jQuery('#preexportbrowse'+uniqid+' div.export-field-options').hide(200);
   jQuery('#preexportbrowse'+uniqid+' div.export-field-options div.export-types').hide();
   jQuery('#preexportbrowse'+uniqid+' .export-image-field').hide(200);
 };

 function clearAllFields(uniqid){
   jQuery('#export-fields-selected'+uniqid).html('');
 };
 var pparam = null;
 function initStoredProc(){
   // target eventuel
   <%if $br___ssmod|count %>
   jQuery('option[value="'+pparam._target+'"]',jQuery('#_target<%$uniqid%>')).prop('selected', true);
   changeTarget();
   <%/if%>
   // les champs
   if (typeof(pparam.selectedfields) != "undefined"
     && pparam.selectedfields.length >0){
     clearAllFields("<%$uniqid%>");
     var fields = jQuery("#export-fields<%$uniqid%>");
     for(var i in pparam.selectedfields){
       var parts = pparam.selectedfields[i].split("#");
       var field = null;
       if(parts.length == 1){
	 field = jQuery('li.field[data-fieldname="'+parts[0]+'"]:not([data-parentfield])',fields);
	 // ou champ objet avec sous champs
	 if (field.length == 0){ 
	   field = jQuery('li>label.field[data-fieldname="'+parts[0]+'"]:not([data-parentfield])',fields);
	 }
       } else if(parts.length == 2){
         field = jQuery('ul>li.field[data-fieldname="'+parts[1]+'"][data-parentfield="'+parts[0]+'"]',fields);
       }
       // on fait des clicks plutôt que des addClass puis export add pour avoir le bon ordre
       if (field != null){
	 jQuery(field).trigger('dblclick');
	 jQuery(field).removeClass('selected');
       } 
     }
   }
   var jform  = jQuery(document.forms['exportForm_<%$uniqid%>']);
   // autres paramètres
   if (typeof(pparam.oidisvisible) != "undefined" && pparam.oidisvisible == "on"){
     jQuery('input[name="oidisvisible"]',jform).prop('checked', true);
   } else {
     jQuery('input[name="oidisvisible"]',jform).prop('checked', false);
   }
   if (typeof(pparam.exportfiles) != "undefined" && pparam.exportfiles == 1){
     jQuery('input[name="exportfiles"]',jform).prop('checked', true);
   } else {
     jQuery('input[name="exportfiles"]',jform).prop('checked', false);
   }
   if (typeof(pparam.exportftp) != "undefined" && pparam.exportftp == 1){
     jQuery('input[name="exportftp"]',jform).prop('checked', true);
   } else {
     jQuery('input[name="exportftp"]',jform).prop('checked', false);
   }
   if (typeof(pparam.ftpserver) != "undefined"){
     jQuery('input[name="ftpserver"]',jform).val(pparam.ftpserver);
   } else {
     jQuery('input[name="ftpserver"]',jform).val('');
   }
   if (typeof(pparam.ftplogin) != "undefined"){
     jQuery('input[name="ftplogin"]',jform).val(pparam.ftplogin);
   } else {
     jQuery('input[name="ftplogin"]',jform).val('');
   }
   if (typeof(pparam.ftppassword) != "undefined"){
     jQuery('input[name="ftppassword"]',jform).val(pparam.ftppassword);
   } else {
     jQuery('input[name="ftppassword"]',jform).val('');
   }
   if (typeof(pparam.fmt) != "undefined"){
     jQuery('select[name="fmt"]>option[value="'+pparam.fmt+'"]',jform).prop('selected', true);
     if (pparam.fmt == 'csv'){
       jQuery('input[name="csvfsep"]',jform).val(pparam.csvfsep);     
       jQuery('input[name="csvtextsep"]',jform).val(pparam.csvtextsep);     
       jQuery('select[name="csvcharset"]>option[value="'+pparam.csvcharset+'"]',jform).prop('selected',true);     
     }
   } else {
     jQuery('input[name="fmt"]',jform).val('xl07');     
   }
   changeFmt();
   changeExportFtp();
   if (typeof(pparam.order) != "undefined"){
     for(var i in pparam.order){
       jQuery('select[name="order\[\]"]>option[value="'+pparam.order[i]+'"]').prop('selected', true);
     }
   }

   if (typeof(pparam.optionsfields) != "undefined"){
     var jsel = jQuery("#export-fields-selected<%$uniqid%>");
     var propsdef = {format:null,naming_convention:null,size:null,crop:null,extent:null,exportfileurl:null};
     for(var f in pparam.optionsfields){
       for(var propname in propsdef){
	 if (typeof(pparam.optionsfields[f][propname]) != "undefined"){
	   jQuery('input[name="optionsfields\['+f+'\]\['+propname+'\]"]', jsel).val(pparam.optionsfields[f][propname]);
	 }
       }
     }
   }
};
function exportSelectedFieldsSelect() {
   var container = jQuery('#preexportbrowse<%$uniqid%>');
   if (jQuery('div.selected-field.active',container).length > 0) {
     jQuery('.img-value .filecomplement',container).focusout();
     jQuery('.naming_convention',container).focusout();
   }

     jQuery(this).parent().toggleClass('active');
     
     var current_field = jQuery(this).data('fieldname');
     var current_field_escape = current_field;
     var ftypes = jQuery(this).data('type');

     if ((ftypes.isAFile) 
	 && jQuery(this).parent().hasClass('active')) {

       if (!ftypes.isAnImage){
	 jQuery('.notAnImageMess', container).show();
       } else {
	 jQuery('.notAnImageMess', container).hide();	 
       }

       jQuery('.export-image-field',container).show(200);
       
       var format = jQuery('#export-fields-selected<%$uniqid%> .selected-field.active input[name=optionsfields\\['+current_field_escape+'\\]\\[format\\]]').val();
       var size = jQuery('#export-fields-selected<%$uniqid%> .selected-field.active input[name=optionsfields\\['+current_field_escape+'\\]\\[size\\]]').val();
       var crop = jQuery('#export-fields-selected<%$uniqid%> .selected-field.active input[name=optionsfields\\['+current_field_escape+'\\]\\[crop\\]]').val();
       var extent = jQuery('#export-fields-selected<%$uniqid%> .selected-field.active input[name=optionsfields\\['+current_field_escape+'\\]\\[extent\\]]').val();
       var exporturl = jQuery('#export-fields-selected<%$uniqid%> .selected-field.active input[name=optionsfields\\['+current_field_escape+'\\]\\[exportfileurl\\]]').val();

       jQuery('.export-field-options input.format').each(function(index, item){
         if (jQuery(item).val() === format) {
           jQuery(item).prop('checked', true);
           jQuery(item).attr('checked', true);
         } else {
           jQuery(item).removeAttr('checked');
         }
       });
       
       var optionPictureSize = size === 'origin' ? 'origin' : 'custom';
       
       if (optionPictureSize === 'custom') {
         jQuery('.export-types .img-value').show(200);
       } else {
         jQuery('.export-types .img-value').hide(200);
       }
       
       jQuery('.export-field-options input.pictureSizeOption').each(function(index, item){
         if (jQuery(item).val() === optionPictureSize) {
           jQuery(item).prop('checked', true);
           jQuery(item).attr('checked', true);
           jQuery(item).addClass('active');
         } else {
           jQuery(item).removeAttr('checked');
         }
       });
       var width, height = '';
       if (size != 'origin') {
         array_size = size.split('x');
         width = array_size[0];
         height = array_size[1];
       }
       
       jQuery('.export-field-options .img-value .width').val(width);
       jQuery('.export-field-options .img-value .height').val(height);
       if (crop == 1){
	 jQuery('.export-field-options div.img-value>label>input.crop').prop('checked', true);
       } else {
	 jQuery('.export-field-options div.img-value>label>input.crop').prop('checked', false);
       }
       if (extent == 1){
	 jQuery('.export-field-options div.img-value>label>input.extent').prop('checked', true);
       } else {
	 jQuery('.export-field-options div.img-value>label>input.extent').prop('checked', false);
       }

       if (exporturl == 1){
         jQuery('.export-field-options div.form-group .checkbox>label>input.exportfileurl').prop('checked', true);
       } else {
         jQuery('.export-field-options div.form-group .checkbox>label>input.exportfileurl').prop('checked', false);
       }

       var naming_convention = jQuery('#export-fields-selected<%$uniqid%> .selected-field.active input[name=optionsfields\\['+current_field_escape+'\\]\\[naming_convention\\]]').val();
       jQuery('.export-field-options .naming_convention').val(naming_convention);
       jQuery('div.export-field-options .export-selected-field').text(jQuery(this).text());
       jQuery('div.export-field-options').show(200);
     } else {
       jQuery('div.export-field-options').hide(200);
       jQuery('div.export-image-field').hide(200);
       jQuery('div.export-field-options div.export-types').hide();
     }

     jQuery('#preexportbrowse<%$uniqid%> div.selected-field .field').each(function(index, item) {
       if (jQuery(item).data('fieldname') != current_field) {
         jQuery(item).parents('.selected-field').removeClass('active');
       }
     });
   };
 
 function initUIAndListeners(){
   jQuery(document).on('click', '#preexportbrowse<%$uniqid%> .tree-toggle span.glyphicon', function (e) {
     jQuery(jQuery(this).parents('li').get(0)).children('ul.tree').toggle(200);
     jQuery(this).parent().toggleClass('active');
     return false;
   });
   
   jQuery(document).on('click', '#preexportbrowse<%$uniqid%> .field', function (e) {
     jQuery(this).toggleClass('selected');
     var current_field = jQuery(this).data('fieldname');
     if (!e.ctrlKey) {
       jQuery('#preexportbrowse<%$uniqid%> .field, #preexportbrowse<%$uniqid%> .fieldgroup').each(function(index, item) {
         if (jQuery(item).data('fieldname') != current_field) {
           jQuery(item).removeClass('selected');
         }
       });
     }
   });

   jQuery(document).on('click', '#preexportbrowse<%$uniqid%> .fieldgroup', function (e) {
     jQuery(this).toggleClass('selected');
     var is_selected = jQuery(this).hasClass('selected');
     var current_group = jQuery(this).data('groupname');
     if (!e.ctrlKey) {
       jQuery('#preexportbrowse<%$uniqid%> .field, #preexportbrowse<%$uniqid%> .fieldgroup').each(function(index, item) {
         if (jQuery(item).data('groupname') != current_group) {
           jQuery(item).removeClass('selected');
         }
       });
     }
     jQuery(this).parent().find('> .tree > .field, > .tree > li > .field').each(function(index, item) {
       if(is_selected) {
         jQuery(this).addClass('selected');
       }
       else {
         jQuery(this).removeClass('selected');
       }
     });
   });

   jQuery(document).on('dblclick', '#preexportbrowse<%$uniqid%> div.export-fields .field', function (evt) {
     jQuery(this).addClass('selected');
     exportAddFields('<%$uniqid%>');
     return false;
   });

   jQuery(document).on('dblclick', '#preexportbrowse<%$uniqid%> div.export-fields .fieldgroup', function (evt) {
     jQuery(this).click();
     exportAddFields('<%$uniqid%>');
     return false;
   });

   jQuery(document).on('click', '#preexportbrowse<%$uniqid%> div.selected-field .field',function(evt){
     exportSelectedFieldsSelect.call(this);
   });

   jQuery(document).on('dblclick', '#preexportbrowse<%$uniqid%> div.selected-field .field', function (evt) {
     jQuery(this).parent().toggleClass('active');
     exportRemoveField('<%$uniqid%>');
     return false;
   });

   jQuery(document).on('click', '#preexportbrowse<%$uniqid%> .pictureSizeOption', function (e) {
     var fn = jQuery('#export-fields-selected<%$uniqid%> .selected-field.active .field').data('fieldname').replace(/(\|)/g, '\\$1');

     if (jQuery('#preexportbrowse<%$uniqid%> .pictureSizeOption:checked').val() === 'custom'){
       jQuery('.export-types .img-value').show(200);
       jQuery(this).addClass('active');

       var width = parseInt(jQuery('.export-field-options .img-value .width').val());
       var height = parseInt(jQuery('.export-field-options .img-value .height').val());

       if (isNaN(width) || isNaN(height)) {
	 var size = 'origin';
       } else {
	 var size = width+'x'+height;
       }

       jQuery('#export-fields-selected<%$uniqid%> .selected-field.active input[name=optionsfields\\['+fn+'\\]\\[size\\]]').val(size);
     } else {
       jQuery('.export-types .img-value').hide(200);
       jQuery(this).removeClass('active');

       jQuery('#export-fields-selected<%$uniqid%> .selected-field.active input[name=optionsfields\\['+fn+'\\]\\[size\\]]').val('origin');
     }

   });

   jQuery(document).on('focusout', '#preexportbrowse<%$uniqid%> .img-value .filecomplement', function(){
     var fn = jQuery('#export-fields-selected<%$uniqid%> .selected-field.active .field').data('fieldname').replace(/(\|)/g, '\\$1');
     var width = parseInt(jQuery('.export-field-options .img-value .width').val());
     var height = parseInt(jQuery('.export-field-options .img-value .height').val());
     var jcrop =   jQuery('.export-field-options .img-value .crop');
     var jextent =   jQuery('.export-field-options .img-value .extent');
     if (isNaN(width) || isNaN(height)) {
       var size = '';
     } else {
       var size = width+'x'+height;
     }
     if (size=='') {
       jQuery('#export-fields-selected<%$uniqid%> .selected-field.active input[name=optionsfields\\['+fn+'\\]\\[size\\]]').val('origin');
       jQuery('#export-fields-selected<%$uniqid%> .selected-field.active input[name=optionsfields\\['+fn+'\\]\\[crop\\]]').val(0);
       jQuery('#export-fields-selected<%$uniqid%> .selected-field.active input[name=optionsfields\\['+fn+'\\]\\[extent\\]]').val(0);
     } else {
       jQuery('#export-fields-selected<%$uniqid%> .selected-field.active input[name=optionsfields\\['+fn+'\\]\\[size\\]]').val(size);
       if (jcrop.prop('checked')){
	jQuery('#export-fields-selected<%$uniqid%> .selected-field.active input[name=optionsfields\\['+fn+'\\]\\[crop\\]]').val('1');
       } else {
	 jQuery('#export-fields-selected<%$uniqid%> .selected-field.active input[name=optionsfields\\['+fn+'\\]\\[crop\\]]').val('0');
       } 
       if (jextent.prop('checked')){
	 jQuery('#export-fields-selected<%$uniqid%> .selected-field.active input[name=optionsfields\\['+fn+'\\]\\[extent\\]]').val('1');
       } else {
	 jQuery('#export-fields-selected<%$uniqid%> .selected-field.active input[name=optionsfields\\['+fn+'\\]\\[extent\\]]').val('0');
       }
     }
   });

   jQuery(document).on('focusout', '#preexportbrowse<%$uniqid%> .naming_convention', function(){
     var fn = jQuery('#export-fields-selected<%$uniqid%> .selected-field.active .field').data('fieldname').replace(/(\|)/g, '\\$1');
     jQuery('#export-fields-selected<%$uniqid%> .selected-field.active input[name=optionsfields\\['+fn+'\\]\\[naming_convention\\]]').val(jQuery(this).val());
   });

   jQuery(document).on('click', '#preexportbrowse<%$uniqid%> .export-image-field input.format', function(){
     var fn = jQuery('#export-fields-selected<%$uniqid%> .selected-field.active .field').data('fieldname').replace(/(\|)/g, '\\$1');
     jQuery('#export-fields-selected<%$uniqid%> .selected-field.active input[name=optionsfields\\['+fn+'\\]\\[format\\]]').val(jQuery(this).val());
   });

   jQuery(document).on('click', '#preexportbrowse<%$uniqid%> .export-types .checkbox input.exportfileurl ', function(){
     var fn = jQuery('#export-fields-selected<%$uniqid%> .selected-field.active .field').data('fieldname').replace(/(\|)/g, '\\$1');
     if (jQuery(this).prop('checked')){
       jQuery('#export-fields-selected<%$uniqid%> .selected-field.active input[name=optionsfields\\['+fn+'\\]\\[exportfileurl\\]]').val('1');
     } else {
       jQuery('#export-fields-selected<%$uniqid%> .selected-field.active input[name=optionsfields\\['+fn+'\\]\\[exportfileurl\\]]').val('0');
     }
   });

   jQuery('#preexportbrowse<%$uniqid%> .export-fields-selected').sortable({
     placeholder: "export-field-highlight"
   }).disableSelection();
 }

 var downloader<%$downloaderid%> = new TZR.Table.Downloader("<%$uniqid%>", "<%$smarty.const.TZR_DOWNLOADER_TMP%>?statusFile=1&disp=inline&mime=application/json&filename=exportStatus_<%$session_id%>_");

 jQuery(document).ready(function () {
   downloader<%$downloaderid%>.init();
   changeFmt();
   changeTarget();
   changeExportFtp();
   
   // listenrer de gestion des champs (voir ensuite : chargement de la procedure à afficher)
  
   initUIAndListeners();

   <%if !empty($br__storedprocedure.oid)%>
   //<%$br__storedprocedure.oid%>
   pparam = JSON.parse("<%$br__storedprocedure.pparam|addslashes%>");
   initStoredProc();
   <%/if%>
   

 });
 
 TZR.addToObjCleaner("preexportbrowse<%$uniqid%>", downloader<%$downloaderid%>);

//# sourceURL=preexportbrowse.js
</script>
